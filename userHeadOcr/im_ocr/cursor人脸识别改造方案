# 头像识别改造方案

## 一、改造目标

根据腾讯云接口文档（https://cloud.tencent.com/document/product/867/47396）的要求，对 `head_ocr.py` 进行以下改造：

1. **限制头像中只有一个人脸**：确保检测到的图片中只包含一张人脸
2. **FaceAttributesType 只识别头像相关参数**：仅请求与头像检测相关的属性类型
3. **返回结果只包含相关参数**：在返回的 FaceDetailInfos 中只保留头像相关的属性信息

## 二、当前代码问题分析

### 2.1 人脸数量限制问题

**当前实现**：
```python
req.MaxFaceNum = 1  # 只检测最大的人脸
```

**问题**：
- `MaxFaceNum = 1` 只是限制 API 返回最大的人脸，但无法验证图片中是否真的只有一张人脸
- 如果图片中有多张人脸，API 只会返回最大的一张，无法发现多张人脸的情况

**解决方案**：
- 将 `MaxFaceNum` 设置为 `5`（API 支持的最大值），这样可以检测到多张人脸
- 在获取 API 响应后，检查 `resp.FaceDetailInfos` 的长度
- 如果检测到多张人脸（`len(resp.FaceDetailInfos) > 1`），直接返回错误，提示"检测到多张人脸，请上传单人头像"

### 2.2 FaceAttributesType 参数问题

**当前实现**：
```python
req.FaceAttributesType = "Headpose,Mask"  # 需要返回姿态和口罩信息
```

**问题**：
- 只包含了 `Headpose`（姿态）和 `Mask`（口罩）两个属性
- 缺少其他头像相关的属性，如 `Eye`（眼睛）、`Hat`（帽子）、`Hair`（头发）等
- 这些属性对于头像质量检测也很重要

**解决方案**：
根据腾讯云 API 文档，头像相关的属性类型包括：
- `Headpose`：姿态信息（上下偏移、左右偏移、平面旋转）
- `Mask`：口罩佩戴信息
- `Eye`：眼睛信息（是否闭眼、是否戴眼镜/墨镜）
- `Hat`：帽子信息（是否佩戴帽子）
- `Hair`：头发信息（可选，用于头像完整性检测）

**推荐配置**：
```python
req.FaceAttributesType = "Headpose,Mask,Eye,Hat"
```

如果需要更严格的检测，可以添加 `Hair`：
```python
req.FaceAttributesType = "Headpose,Mask,Eye,Hat,Hair"
```

### 2.3 返回结果过滤问题

**当前实现**：
```python
# 返回结果中包含了所有检测到的属性
"details": {
    "faceRect": {...},
    "headPose": {...},
    "mask": {...}
}
```

**问题**：
- 虽然当前只请求了 `Headpose` 和 `Mask`，但返回结构没有明确限制
- 如果后续添加了更多属性类型，返回结果可能会包含不相关的属性

**解决方案**：
- 在构建返回结果时，明确只提取头像相关的属性
- 创建一个辅助方法 `_extract_avatar_attributes()` 来提取和过滤属性
- 只返回以下属性：
  - `FaceRect`：人脸框位置（必需）
  - `HeadPose`：姿态信息（如果请求了）
  - `Mask`：口罩信息（如果请求了）
  - `Eye`：眼睛信息（如果请求了）
  - `Hat`：帽子信息（如果请求了）
  - `Hair`：头发信息（如果请求了）

## 三、具体改造方案

### 3.1 修改 `check_avatar` 方法

#### 3.1.1 修改 API 请求参数

**位置**：`head_ocr.py` 第 240-245 行

**修改前**：
```python
req = models.DetectFaceAttributesRequest()
req.MaxFaceNum = 1  # 只检测最大的人脸
req.FaceModelVersion = "3.0"
# 需要返回姿态和口罩信息
req.FaceAttributesType = "Headpose,Mask"
```

**修改后**：
```python
req = models.DetectFaceAttributesRequest()
req.MaxFaceNum = 5  # 检测最多5张人脸，用于验证是否只有一张
req.FaceModelVersion = "3.0"
# 只请求头像相关的属性：姿态、口罩、眼睛、帽子
req.FaceAttributesType = "Headpose,Mask,Eye,Hat"
```

#### 3.1.2 添加人脸数量验证

**位置**：`head_ocr.py` 第 288-296 行之后

**修改前**：
```python
# 检查是否检测到人脸
if not resp.FaceDetailInfos or len(resp.FaceDetailInfos) == 0:
    return {
        "hasValidAvatar": False,
        "faceCount": 0,
        "message": "图片中未检测到人脸",
        ...
    }
```

**修改后**：
```python
# 检查是否检测到人脸
if not resp.FaceDetailInfos or len(resp.FaceDetailInfos) == 0:
    return {
        "hasValidAvatar": False,
        "faceCount": 0,
        "message": "图片中未检测到人脸",
        ...
    }

# 验证是否只有一张人脸（头像要求）
if len(resp.FaceDetailInfos) > 1:
    return {
        "hasValidAvatar": False,
        "faceCount": len(resp.FaceDetailInfos),
        "message": "检测到多张人脸，请上传单人头像",
        "imagePath": actual_image_path,
        "imageSource": image_source.value
    }
```

#### 3.1.3 修改返回结果构建逻辑

**位置**：`head_ocr.py` 第 360-384 行

**修改前**：
```python
# 所有检查通过
return {
    "hasValidAvatar": True,
    "faceCount": len(resp.FaceDetailInfos),
    "message": "检测到有效头像",
    "details": {
        "faceRect": {
            "x": face_rect.X,
            "y": face_rect.Y,
            "width": face_rect.Width,
            "height": face_rect.Height
        },
        "headPose": {
            "pitch": head_pose.Pitch if head_pose else None,
            "yaw": head_pose.Yaw if head_pose else None,
            "roll": head_pose.Roll if head_pose else None
        } if head_pose else None,
        "mask": {
            "type": mask.Type if mask else None,
            "probability": mask.Probability if mask else None
        } if mask else None
    },
    "imagePath": actual_image_path,
    "imageSource": image_source.value
}
```

**修改后**：
```python
# 所有检查通过
# 提取头像相关的属性信息
avatar_attributes = self._extract_avatar_attributes(face_info)

return {
    "hasValidAvatar": True,
    "faceCount": 1,  # 已验证只有一张人脸
    "message": "检测到有效头像",
    "details": avatar_attributes,
    "imagePath": actual_image_path,
    "imageSource": image_source.value
}
```

### 3.2 添加辅助方法 `_extract_avatar_attributes`

**位置**：在 `_check_mask` 方法之后添加

**新增方法**：
```python
def _extract_avatar_attributes(self, face_info) -> Dict[str, Any]:
    """
    从 FaceDetailInfo 中提取头像相关的属性
    
    Args:
        face_info: FaceDetailInfo 对象
    
    Returns:
        dict: 包含头像相关属性的字典
    """
    attrs = face_info.FaceDetailAttributesInfo if face_info else None
    face_rect = face_info.FaceRect if face_info else None
    
    result = {}
    
    # 人脸框位置（必需）
    if face_rect:
        result["faceRect"] = {
            "x": face_rect.X,
            "y": face_rect.Y,
            "width": face_rect.Width,
            "height": face_rect.Height
        }
    
    # 姿态信息（如果存在）
    if attrs and hasattr(attrs, 'HeadPose') and attrs.HeadPose:
        head_pose = attrs.HeadPose
        result["headPose"] = {
            "pitch": head_pose.Pitch,
            "yaw": head_pose.Yaw,
            "roll": head_pose.Roll
        }
    
    # 口罩信息（如果存在）
    if attrs and hasattr(attrs, 'Mask') and attrs.Mask:
        mask = attrs.Mask
        result["mask"] = {
            "type": mask.Type,
            "probability": mask.Probability
        }
    
    # 眼睛信息（如果存在）
    if attrs and hasattr(attrs, 'Eye') and attrs.Eye:
        eye = attrs.Eye
        eye_info = {}
        
        # 眼睛开合状态
        if hasattr(eye, 'EyeOpen') and eye.EyeOpen:
            eye_info["eyeOpen"] = {
                "type": eye.EyeOpen.Type,
                "probability": eye.EyeOpen.Probability
            }
        
        # 眼镜/墨镜信息
        if hasattr(eye, 'Glass') and eye.Glass:
            eye_info["glass"] = {
                "type": eye.Glass.Type,
                "probability": eye.Glass.Probability
            }
        
        if eye_info:
            result["eye"] = eye_info
    
    # 帽子信息（如果存在）
    if attrs and hasattr(attrs, 'Hat') and attrs.Hat:
        hat = attrs.Hat
        hat_info = {}
        
        # 帽子样式
        if hasattr(hat, 'Style') and hat.Style:
            hat_info["style"] = {
                "type": hat.Style.Type,
                "probability": hat.Style.Probability
            }
        
        # 帽子状态
        if hasattr(hat, 'State') and hat.State:
            hat_info["state"] = {
                "type": hat.State.Type,
                "probability": hat.State.Probability
            }
        
        if hat_info:
            result["hat"] = hat_info
    
    # 头发信息（如果存在，可选）
    if attrs and hasattr(attrs, 'Hair') and attrs.Hair:
        hair = attrs.Hair
        hair_info = {}
        
        # 头发长度
        if hasattr(hair, 'Length') and hair.Length:
            hair_info["length"] = {
                "type": hair.Length.Type,
                "probability": hair.Length.Probability
            }
        
        # 是否有刘海
        if hasattr(hair, 'Bang') and hair.Bang:
            hair_info["bang"] = {
                "type": hair.Bang.Type,
                "probability": hair.Bang.Probability
            }
        
        # 头发颜色
        if hasattr(hair, 'Color') and hair.Color:
            hair_info["color"] = {
                "type": hair.Color.Type,
                "probability": hair.Color.Probability
            }
        
        if hair_info:
            result["hair"] = hair_info
    
    return result
```

### 3.3 更新错误处理中的 faceCount

**位置**：`head_ocr.py` 中所有返回错误的地方

**修改说明**：
- 在检测到多张人脸时，`faceCount` 应该返回实际检测到的人脸数量
- 在其他错误情况下，`faceCount` 应该返回 `len(resp.FaceDetailInfos)`（如果 API 调用成功）或 `0`（如果 API 调用失败）

## 四、改造后的代码流程

### 4.1 完整的检测流程

```
1. 判断图片类型（本地文件/直接URL/百度URL）
   ↓
2. 构建 API 请求
   - MaxFaceNum = 5（检测多张人脸）
   - FaceAttributesType = "Headpose,Mask,Eye,Hat"（只请求头像相关属性）
   ↓
3. 调用 DetectFaceAttributes API
   ↓
4. 检查是否检测到人脸
   - 如果没有：返回错误
   ↓
5. 验证人脸数量
   - 如果 > 1：返回错误"检测到多张人脸"
   - 如果 = 1：继续处理
   ↓
6. 获取第一张人脸（也是唯一一张）
   ↓
7. 检查人脸框、姿态、口罩等属性
   ↓
8. 提取头像相关属性（使用 _extract_avatar_attributes）
   ↓
9. 返回结果（只包含头像相关的属性）
```

## 五、改造影响分析

### 5.1 兼容性影响

**向后兼容性**：
- ✅ 返回结果的结构基本保持不变，只是增加了新的属性字段（`eye`、`hat` 等）
- ✅ 原有的 `faceRect`、`headPose`、`mask` 字段保持不变
- ⚠️ `faceCount` 在成功情况下固定为 `1`（之前可能是 `1` 或其他值）

**API 调用变化**：
- ⚠️ `MaxFaceNum` 从 `1` 改为 `5`，可能会略微增加 API 响应时间（但影响很小）
- ✅ `FaceAttributesType` 增加了 `Eye` 和 `Hat`，会增加一些计算成本，但能提供更完整的头像检测

### 5.2 功能改进

**新增功能**：
1. ✅ 能够检测并拒绝多张人脸的头像
2. ✅ 能够检测眼睛状态（闭眼、墨镜）
3. ✅ 能够检测帽子佩戴情况
4. ✅ 返回结果更加完整和规范

**检测精度提升**：
- 更严格的人脸数量验证
- 更全面的头像质量检测

## 六、测试建议

### 6.1 单元测试用例

1. **单人脸测试**：上传只有一张人脸的图片，验证返回 `hasValidAvatar=True`，`faceCount=1`
2. **多人脸测试**：上传包含多张人脸的图片，验证返回 `hasValidAvatar=False`，`message="检测到多张人脸"`
3. **无人脸测试**：上传不包含人脸的图片，验证返回 `hasValidAvatar=False`，`faceCount=0`
4. **属性提取测试**：验证返回的 `details` 中只包含请求的属性（`faceRect`、`headPose`、`mask`、`eye`、`hat`）

### 6.2 集成测试

1. 测试本地文件输入
2. 测试直接 URL 输入
3. 测试百度图片搜索 URL 输入
4. 测试各种头像质量情况（正常、闭眼、戴口罩、戴帽子等）

## 七、实施步骤

1. **第一步**：修改 API 请求参数（`MaxFaceNum` 和 `FaceAttributesType`）
2. **第二步**：添加人脸数量验证逻辑
3. **第三步**：实现 `_extract_avatar_attributes` 辅助方法
4. **第四步**：修改返回结果构建逻辑，使用新的辅助方法
5. **第五步**：更新所有错误处理中的 `faceCount` 字段
6. **第六步**：运行测试，验证功能正确性
7. **第七步**：更新相关文档和注释

## 八、注意事项

1. **API 限制**：
   - `MaxFaceNum` 最大值为 `120`，设置为 `5` 已经足够检测多张人脸
   - `FaceAttributesType` 中的属性类型用逗号分隔，大小写不敏感

2. **性能考虑**：
   - 增加 `Eye` 和 `Hat` 属性可能会略微增加 API 响应时间，但影响很小
   - 将 `MaxFaceNum` 从 `1` 改为 `5` 的影响也很小，因为 API 会优先返回最大的人脸

3. **错误处理**：
   - 确保在所有错误情况下都正确设置 `faceCount`
   - 多张人脸的情况应该在 API 调用成功后立即检查，避免后续处理

4. **代码维护**：
   - `_extract_avatar_attributes` 方法应该根据实际返回的数据结构进行调整
   - 如果后续需要添加更多属性类型，只需要在 `FaceAttributesType` 和 `_extract_avatar_attributes` 中添加即可
