# 头像 OCR 识别系统 - 技术文档

> 最后更新时间：2025年12月08日

## 1. 项目概述

本项目是一个基于 FastAPI 的 Web 应用系统，主要用于头像 OCR 识别和参数调优。系统通过集成腾讯云人脸识别 API，实现对头像图片的自动检测和验证，支持自定义人脸姿态阈值配置，帮助用户找到最佳的 OCR 识别参数。

### 1.1 核心功能

- **图片管理**：支持本地文件上传和 URL 下载两种方式添加图片
- **头像 OCR 识别**：基于腾讯云人脸识别 API，检测头像的有效性
- **参数配置**：可自定义人脸姿态阈值（Pitch、Yaw、Roll）
- **批量处理**：支持批量 OCR 识别，提高处理效率
- **结果导出**：支持将识别结果导出为 Excel 文件
- **数据管理**：完整的 CRUD 操作，支持数据的增删改查

### 1.2 应用场景

- 头像审核系统：自动检测用户上传的头像是否符合规范
- 参数调优：通过大量样本测试，找到最佳的识别参数配置
- 数据标注：标记样本是否应该通过，用于训练和验证

## 2. 技术架构

### 2.1 技术栈

#### 后端
- **框架**：FastAPI 3.x
- **语言**：Python 3.8+
- **数据存储**：JSONL 格式文件（通过 `jsonline.py` 管理）
- **云服务**：腾讯云人脸识别 API（IAI）

#### 前端
- **框架**：Vue 3
- **UI 组件库**：Element Plus
- **HTTP 客户端**：Axios
- **Excel 导出**：SheetJS (XLSX)

### 2.2 项目结构

```
demo/
├── backend.py              # FastAPI 后端服务入口
├── jsonline.py             # JSONL 数据操作工具类
├── data/
│   └── app_data.json       # 数据存储文件（JSONL 格式）
├── imgs/                   # 图片存储目录
│   └── avatar_*.jpg        # 下载/上传的头像图片
├── static/
│   └── index.html          # 前端单页面应用
└── cursor_docs/
    └── 技术文档.md         # 本文档
```

## 3. 核心模块详解

### 3.1 HeadOCR 类（头像检测器）

`HeadOCR` 类封装了腾讯云人脸识别 API 的调用逻辑，提供头像检测功能。

#### 3.1.1 主要功能

- **人脸检测**：检测图片中是否存在人脸
- **姿态检测**：检测人脸的俯仰角（Pitch）、偏航角（Yaw）、旋转角（Roll）
- **口罩检测**：检测是否佩戴口罩及佩戴方式
- **人脸框验证**：验证检测到的人脸框是否合理

#### 3.1.2 支持的图片输入类型

1. **本地文件**（`ImageSource.LOCAL_FILE`）
   - 相对路径或绝对路径
   - 自动转换为 base64 编码后调用 API

2. **直接图片 URL**（`ImageSource.DIRECT_URL`）
   - 可直接访问的图片 URL
   - 直接使用 URL 参数调用 API

3. **百度图片搜索 URL**（`ImageSource.BAIDU_URL`）
   - 自动提取实际图片 URL
   - 支持从百度图片搜索结果中提取真实图片地址

#### 3.1.3 姿态阈值配置

默认阈值：
- **Pitch（俯仰角）**：-10° ~ 10°
- **Yaw（偏航角）**：-10° ~ 10°
- **Roll（旋转角）**：-20° ~ 20°

这些阈值可以通过 API 请求参数动态调整。

#### 3.1.4 检测结果结构

```python
{
    "hasValidAvatar": bool,      # 是否检测到有效头像
    "faceCount": int,             # 检测到的人脸数量
    "message": str,               # 检测结果消息
    "details": {
        "faceRect": {             # 人脸框信息
            "x": int,
            "y": int,
            "width": int,
            "height": int
        },
        "headPose": {             # 人脸姿态信息
            "pitch": float,
            "yaw": float,
            "roll": float
        },
        "mask": {                 # 口罩信息
            "type": int,          # 0-无口罩, 1-有口罩不遮脸, 2-遮下巴, 3-遮嘴, 4-正确佩戴
            "probability": float
        }
    },
    "imagePath": str,             # 图片路径或 URL
    "imageSource": str,           # 图片来源类型
    "config": {                   # 使用的配置参数
        "pitch_min": int,
        "pitch_max": int,
        "yaw_min": int,
        "yaw_max": int,
        "roll_min": int,
        "roll_max": int
    }
}
```

### 3.2 JsonLineDB 类（数据存储）

`JsonLineDB` 类提供了基于 JSONL 格式文件的轻量级数据库操作。

#### 3.2.1 主要方法

- `read_all()`: 全量读取所有数据，按 id 升序排序
- `upsert(data)`: 新增或更新数据（如果 id 存在则更新，否则新增）
- `delete(data_id)`: 根据 id 删除数据
- `get_by_id(data_id)`: 根据 id 查询单条数据
- `exists(data_id)`: 检查指定 id 的数据是否存在

#### 3.2.2 数据格式

每条数据记录包含以下字段：
- `id`: 唯一标识符（整数）
- `URL`: 图片源地址
- `本地文件名`: 下载/上传后的本地文件名
- `下载时间`: 图片下载/上传的时间戳
- `ocr_result`: OCR 识别结果（JSON 字符串）
- `should_pass`: 是否应该通过（布尔值，用于标注）
- `ocr_passed`: OCR 是否通过（布尔值，根据识别结果自动设置）

### 3.3 API 接口

#### 3.3.1 数据管理接口

**GET /api/items**
- 功能：获取所有数据项
- 返回：按 id 降序排列的数据列表

**POST /api/items**
- 功能：新增数据项
- 请求参数：
  - `url`（可选）：图片 URL
  - `file`（可选）：上传的图片文件
  - `should_pass`（可选）：是否应该通过
- 说明：`url` 和 `file` 至少提供一个

**PUT /api/items/{item_id}**
- 功能：更新指定数据项
- 请求体：`Item` 模型（JSON）
- 说明：如果 URL 发生变化，会自动重新下载图片

**DELETE /api/items/{item_id}**
- 功能：删除指定数据项

#### 3.3.2 OCR 识别接口

**POST /api/items/{item_id}/ocr**
- 功能：对指定图片进行 OCR 识别
- 请求体：
  ```json
  {
    "pitch_min": -10,
    "pitch_max": 10,
    "yaw_min": -10,
    "yaw_max": 10,
    "roll_min": -20,
    "roll_max": 20
  }
  ```
- 返回：
  ```json
  {
    "success": true,
    "ocr_result": "...",  // JSON 字符串
    "ocr_passed": true    // 布尔值
  }
  ```

#### 3.3.3 静态资源接口

**GET /images/{filename}**
- 功能：获取图片文件
- 说明：FastAPI 静态文件服务

**GET /**
- 功能：前端页面
- 说明：返回 `static/index.html`

## 4. 前端功能

### 4.1 主要功能模块

1. **数据列表展示**
   - 表格形式展示所有数据项
   - 支持图片预览（点击可查看大图）
   - 显示 OCR 识别结果摘要和参数配置

2. **OCR 参数配置**
   - 可配置 Pitch、Yaw、Roll 的最小值和最大值
   - 提供预设配置（腾讯云默认、宽松配置）
   - 配置自动保存到 localStorage

3. **批量操作**
   - 支持多选数据项
   - 批量 OCR 识别
   - 批量导出结果

4. **数据管理**
   - 新增数据（支持 URL 和文件上传）
   - 编辑数据（仅可修改 URL）
   - 删除数据

5. **结果导出**
   - 导出为 Excel 文件
   - 包含所有字段和 OCR 结果

### 4.2 前端技术实现

- **状态管理**：使用 Vue 3 的 `reactive` 和 `ref`
- **配置持久化**：使用 `localStorage` 保存 OCR 配置
- **文件上传**：使用 FormData 和 multipart/form-data
- **Excel 导出**：使用 SheetJS 库

## 5. 部署与运行

### 5.1 环境要求

- Python 3.8+
- 已安装项目依赖（见 `requirements.txt`）

### 5.2 安装依赖

```bash
pip install fastapi uvicorn python-multipart tencentcloud-sdk-python requests
```

### 5.3 配置腾讯云密钥

设置环境变量：
```bash
export TENCENT_SECRET_ID="your_secret_id"
export TENCENT_SECRET_KEY="your_secret_key"
```

或在 `backend.py` 中直接修改（不推荐用于生产环境）：
```python
SECRET_ID = os.environ.get("TENCENT_SECRET_ID", "your_secret_id")
SECRET_KEY = os.environ.get("TENCENT_SECRET_KEY", "your_secret_key")
```

### 5.4 启动服务

```bash
# 方式1：直接运行
python backend.py

# 方式2：使用 uvicorn
uvicorn backend:app --host 0.0.0.0 --port 8000 --reload
```

服务启动后，访问 `http://localhost:8000` 即可使用。

## 6. 数据流程

### 6.1 图片添加流程

1. 用户通过前端上传文件或提供 URL
2. 后端接收请求，生成唯一 ID
3. 如果是 URL，下载图片到 `imgs/` 目录
4. 如果是文件，保存到 `imgs/` 目录
5. 将数据写入 `data/app_data.json`

### 6.2 OCR 识别流程

1. 用户选择数据项，点击 OCR 识别
2. 前端发送请求，包含 OCR 参数配置
3. 后端读取本地图片文件
4. 调用 `HeadOCR.check_avatar()` 方法
5. 腾讯云 API 返回检测结果
6. 后端保存结果到数据库
7. 前端更新显示

### 6.3 批量处理流程

1. 用户选择多个数据项
2. 点击批量 OCR 识别
3. 前端依次调用 OCR 接口（串行处理）
4. 显示处理进度和结果统计

## 7. 注意事项

### 7.1 数据安全

- ⚠️ **重要**：腾讯云密钥不应硬编码在代码中，应使用环境变量
- ⚠️ **重要**：生产环境应配置 HTTPS
- ⚠️ **重要**：图片文件应限制大小，避免存储空间问题

### 7.2 并发处理

- 当前实现为单线程处理，不支持并发 OCR 识别
- 批量处理为串行执行，避免同时调用过多 API
- 如需并发，需要实现队列机制和限流

### 7.3 数据一致性

- JSONL 文件操作使用临时文件+原子替换，保证数据一致性
- 多用户同时操作可能导致数据覆盖，建议添加锁机制

### 7.4 API 限制

- 腾讯云人脸识别 API 有调用频率限制
- 建议添加错误重试机制和限流控制
- 注意 API 费用，避免大量调用产生高额费用

## 8. 扩展建议

### 8.1 功能扩展

- 添加用户认证和权限管理
- 支持更多图片格式和大小限制
- 添加 OCR 结果统计分析功能
- 支持自定义检测规则

### 8.2 性能优化

- 使用数据库替代 JSONL 文件（如 SQLite、PostgreSQL）
- 实现图片缓存和 CDN
- 添加 Redis 缓存 OCR 结果
- 实现异步任务队列（如 Celery）

### 8.3 架构优化

- 前后端分离部署
- 使用 Docker 容器化部署
- 添加日志系统和监控
- 实现 API 版本管理

## 9. 常见问题

### Q1: OCR 识别失败怎么办？

A: 检查以下几点：
- 图片文件是否存在
- 腾讯云密钥是否正确配置
- 网络连接是否正常
- API 调用是否超出限制

### Q2: 如何调整识别阈值？

A: 在前端 OCR 参数配置区域修改 Pitch、Yaw、Roll 的值，或使用预设配置。

### Q3: 数据丢失了怎么办？

A: JSONL 文件操作使用原子替换，正常情况下不会丢失数据。建议定期备份 `data/app_data.json` 文件。

### Q4: 如何批量导入图片？

A: 当前版本不支持批量导入，需要逐个添加。可以扩展 API 接口支持批量上传。

## 10. 更新日志

### v1.0.0 (2025-12-08)
- 初始版本发布
- 实现基本的 CRUD 功能
- 集成腾讯云人脸识别 API
- 支持 OCR 参数配置
- 支持批量处理和结果导出
